# 要件定義書：Google Calendar Importer Plugin for Obsidian

## 1. プロジェクト概要

### 1.1 目的
ObsidianのDaily Notesに、Googleカレンダーの予定を効率的にインポートし、ナレッジベースとカレンダー情報を統合することで、日次振り返りや計画立案を支援する。

### 1.2 背景
- Obsidianユーザーは、Daily Notesを使って日々の記録や計画を管理している
- カレンダーの予定を手動で転記するのは非効率的
- カレンダー情報とノートを連携させることで、文脈を持った記録が可能になる

### 1.3 スコープ
- **対象範囲**：Google Calendar APIからの予定取得とObsidian Daily Notesへの挿入
- **対象外**：予定の編集・削除、複数カレンダープロバイダー対応、モバイル専用機能

## 2. 機能要件

### 2.1 コア機能

#### FR-001: 現在開いているDaily Noteの日付に対応する予定のインポート
- **優先度**: 必須
- **説明**: ユーザーが現在開いているDaily Noteのファイル名から日付を判定し、その日付の予定をGoogle Calendarから取得してインポートする
- **根拠**: Daily Notesプラグインは日付ベースでノートを管理しており、ファイル名またはメタデータから日付を取得できる
- **依存**: FR-003（Google Calendar API連携）
- **検証基準**:
  - Daily Noteが開かれている状態でコマンドを実行できる
  - ファイル名から正しく日付が抽出される（例：2025-01-15.md → 2025年1月15日）
  - 該当日の予定が全て取得される

#### FR-002: カーソル位置への予定挿入
- **優先度**: 必須
- **説明**: インポートした予定を、エディタの現在のカーソル位置に挿入する
- **根拠**: ユーザーが任意の位置に予定を配置できる柔軟性が必要
- **依存**: FR-001
- **検証基準**:
  - カーソル位置に予定が正しく挿入される
  - 既存のテキストを破壊しない
  - 複数回実行しても既存の挿入内容と重複しない（冪等性は不要、警告のみ）

#### FR-003: Google Calendar API連携
- **優先度**: 必須
- **説明**: Google Calendar API（サービスアカウント認証）を使用して、指定日付の予定を取得する
- **根拠**: サービスアカウントを使用することで、ユーザーごとのOAuth認証フローを避けられる
- **依存**: なし
- **検証基準**:
  - サービスアカウントのJSONキーファイルで認証できる
  - 指定された日付範囲（0:00〜23:59）の予定を取得できる
  - APIエラー時に適切なエラーメッセージを表示する

#### FR-004: 予定フォーマットのカスタマイズ
- **優先度**: 必須
- **説明**: インポートする予定の出力フォーマットをユーザーが設定できる
- **根拠**: ユーザーごとにノートの記述スタイルが異なるため、柔軟なフォーマット設定が必要
- **依存**: FR-001, FR-002
- **検証基準**:
  - 設定画面でフォーマットテンプレートを編集できる
  - テンプレート内で以下の変数が使用できる：
    - `{{title}}`: 予定のタイトル
    - `{{startTime}}`: 開始時刻
    - `{{endTime}}`: 終了時刻
    - `{{description}}`: 予定の説明
    - `{{location}}`: 場所
    - `{{attendees}}`: 参加者リスト
  - デフォルトフォーマット：`- {{startTime}}-{{endTime}}: {{title}}`

#### FR-005: サービスアカウント認証情報の設定
- **優先度**: 必須
- **説明**: プラグインの設定画面から、Google Calendar APIのサービスアカウントJSONキーファイルの内容を設定できる
- **根拠**: 認証情報をプラグインに保存する必要がある
- **依存**: なし
- **検証基準**:
  - 設定画面にテキストエリアが表示される
  - JSONキーファイルの内容をペーストして保存できる
  - 不正なJSON形式の場合はエラーメッセージを表示する
  - 保存された認証情報は暗号化されずに保存される（ローカルVaultのため）

### 2.2 追加機能

#### FR-006: コマンドパレットからの実行
- **優先度**: 必須
- **説明**: Obsidianのコマンドパレット（Ctrl/Cmd+P）から予定インポート機能を実行できる
- **根拠**: Obsidianの標準的なUI操作パターン
- **依存**: FR-001
- **検証基準**:
  - コマンドパレットに「Import Google Calendar events」というコマンドが表示される
  - コマンド実行で予定がインポートされる

#### FR-007: カレンダーID設定
- **優先度**: 必須
- **説明**: 取得対象のGoogle CalendarのIDを設定画面で指定できる
- **根拠**: サービスアカウントでアクセスできるカレンダーを特定する必要がある
- **依存**: FR-003
- **検証基準**:
  - 設定画面でカレンダーIDを入力できる
  - 初回リリースでは単一カレンダーのみサポート
  
#### FR-008: 複数カレンダー対応（将来拡張）
- **優先度**: 任意（将来の機能拡張として計画）
- **説明**: 複数のカレンダーIDから予定を同時に取得してマージ表示できる
- **根拠**: 複数カレンダーを使い分けるユーザーのニーズに対応
- **依存**: FR-007
- **検証基準**:
  - 設定画面で複数のカレンダーIDをカンマ区切りで指定できる
  - 各カレンダーからの予定を時系列順にマージして表示する
- **備考**: 初回リリースでは対象外。ユーザーからの要望が高い場合に実装を検討

#### FR-009: タイムゾーン設定
- **優先度**: 推奨
- **説明**: 予定の時刻表示に使用するタイムゾーンを設定できる
- **根拠**: Google Calendarはタイムゾーン情報を含むため、表示時に適切なタイムゾーンに変換する必要がある
- **依存**: FR-001
- **検証基準**:
  - 設定画面でタイムゾーンを選択できる（デフォルト：システムのタイムゾーン）
  - 予定の時刻が設定されたタイムゾーンで表示される

#### FR-010: 終日予定の扱い
- **優先度**: 必須
- **説明**: 終日予定（all-day event）を通常予定とは別のフォーマットテンプレートで表示する
- **根拠**: 終日予定は時刻情報を持たないため、別のフォーマットが必要。ユーザーからの明確な要望により必須機能として実装する
- **依存**: FR-004
- **検証基準**:
  - 終日予定の場合、時刻を表示しない
  - 終日予定用のフォーマットテンプレートを通常予定とは別に設定できる
  - 通常予定用デフォルトフォーマット：`- {{startTime}}-{{endTime}}: {{title}}`
  - 終日予定用デフォルトフォーマット：`- [終日] {{title}}`

## 3. 非機能要件

### 3.1 性能要件

#### NFR-001: API応答時間
- **優先度**: 推奨
- **基準**: Google Calendar APIへのリクエストは10秒以内に完了すること
- **根拠**: ユーザーがコマンド実行後に待たされる時間を最小化する
- **検証方法**: ネットワーク遅延を考慮した通常環境でのテスト

#### NFR-002: UI応答性
- **優先度**: 必須
- **基準**: 予定のインポート処理中もObsidianのUIがフリーズしないこと
- **根拠**: 長時間の同期処理中もユーザーは他の作業を継続できるべき
- **検証方法**: API呼び出し中に他のノートが開けることを確認

### 3.2 セキュリティ要件

#### NFR-003: 認証情報の保護
- **優先度**: 必須
- **基準**: 
  - サービスアカウントの秘密鍵はObsidianのプラグインデータ領域に保存される
  - データはローカルVaultに保存されるため、Vault自体のセキュリティに依存する
- **根拠**: 認証情報の漏洩を防ぐ（ただしローカル環境のため暗号化は任意）
- **検証方法**: 
  - 設定データの保存場所を確認
  - プラグイン設定ファイルに平文で保存されることを文書化

#### NFR-004: API権限の最小化
- **優先度**: 必須
- **基準**: Google Calendar APIに対して、読み取り専用のスコープ（`https://www.googleapis.com/auth/calendar.readonly`）のみを要求すること
- **根拠**: セキュリティベストプラクティスに従い、必要最小限の権限のみを使用する
- **検証方法**: サービスアカウントの権限設定を確認

### 3.3 保守性要件

#### NFR-005: コード品質
- **優先度**: 推奨
- **基準**:
  - TypeScriptの型チェックエラーがないこと
  - ESLintのルール違反がないこと
  - 主要な関数に対してコメントが記述されていること
- **根拠**: 将来の機能拡張やバグ修正を容易にする
- **検証方法**: `npm run build`でビルドが成功すること

#### NFR-006: エラーハンドリング
- **優先度**: 必須
- **基準**:
  - API呼び出しの失敗時に、ユーザーフレンドリーなエラーメッセージを表示すること
  - ネットワークエラー、認証エラー、権限エラーを区別して表示すること
- **根拠**: ユーザーが問題を自己解決できるようにする
- **検証方法**: 
  - 不正な認証情報でのエラーメッセージ確認
  - ネットワーク切断時のエラーメッセージ確認

#### NFR-007: ログ出力
- **優先度**: 推奨
- **基準**: API呼び出しやエラー発生時に、開発者コンソールにログを出力すること
- **根拠**: トラブルシューティングを容易にする
- **検証方法**: コンソールログの出力内容を確認

### 3.4 可用性要件

#### NFR-008: オフライン動作
- **優先度**: 任意
- **基準**: ネットワークが利用できない場合、適切なエラーメッセージを表示し、プラグイン自体はクラッシュしないこと
- **根拠**: プラグインの安定性を保つ
- **検証方法**: ネットワーク切断時の動作確認

#### NFR-009: Obsidianバージョン互換性
- **優先度**: 必須
- **基準**: Obsidian 0.15.0以降で動作すること
- **根拠**: manifest.jsonで指定される最小バージョン要件
- **検証方法**: 複数のObsidianバージョンでの動作確認

### 3.5 ユーザビリティ要件

#### NFR-010: セットアップドキュメント
- **優先度**: 必須
- **基準**: README.mdに以下の内容を含むこと
  - Google Cloud Consoleでのサービスアカウント作成手順
  - カレンダーのサービスアカウントへの共有方法
  - プラグインの設定手順
  - トラブルシューティングガイド
- **根拠**: 技術的知識が限られたユーザーでもセットアップできるようにする
- **検証方法**: ドキュメントレビュー

#### NFR-011: 進捗フィードバック
- **優先度**: 推奨
- **基準**: 予定のインポート開始・完了時にNotice（通知）を表示すること
- **根拠**: ユーザーに処理状況を伝える
- **検証方法**: コマンド実行時の通知表示を確認

## 4. 制約条件

### 4.1 技術的制約

#### C-001: 技術スタック
- **TypeScript 4.7.4**を使用
- **Node.js v16以上**が必要
- **Obsidian Plugin API**に準拠
- **googleapis**ライブラリを使用してGoogle Calendar APIにアクセス

#### C-002: プラットフォーム制約
- Obsidianがサポートするプラットフォーム（Windows、macOS、Linux）で動作する
- モバイル（iOS、Android）での動作は現時点では対象外
  - Node.jsモジュール（googleapis）の互換性の問題により、現在の実装ではモバイル対応が困難
  - 将来的にはモバイル対応を検討する可能性あり（最優先度は最低）
  - モバイル対応する場合は、認証方式（OAuth 2.0への変更など）の再検討が必要

#### C-003: 認証方式の制約
- Google Calendar APIへのアクセスには**サービスアカウント認証のみ**を使用
- OAuth 2.0フローは実装しない（複雑性とセキュリティリスクを避けるため）

#### C-004: Daily Notesプラグインへの依存
- Obsidian標準のDaily Notesプラグインが有効化されていることを前提とする
- Daily Notesのフォーマット設定（日付フォーマット、保存フォルダなど）を尊重する

### 4.2 外部依存

#### C-005: Google Calendar API
- Google Calendar API v3を使用
- サービスアカウントに対象カレンダーへの閲覧権限が付与されている必要がある
- API使用制限（クォータ）はGoogle Cloud Projectの設定に依存

#### C-006: ネットワーク接続
- インターネット接続が必要
- プロキシ環境での動作は未サポート（任意対応）

### 4.3 運用制約

#### C-007: データ保存
- プラグイン設定はObsidianのプラグインデータディレクトリ（`.obsidian/plugins/google-calendar-importer/data.json`）に保存される
- Vault間で設定を共有する場合は、ユーザーが手動でファイルをコピーする必要がある

#### C-008: API使用量
- Google Calendar APIの無料枠（100万リクエスト/日）を前提とする
- 大量の予定を頻繁にインポートする場合、クォータ制限に注意が必要

### 4.4 スコープ外の項目

**初回リリースで実装しない機能**：
- 予定の作成・編集・削除機能
- カレンダーとノートの双方向同期
- 複数カレンダーサービス（Outlook、Apple Calendarなど）のサポート
- リアルタイム同期・自動更新機能
- 過去の予定の一括インポート機能（ユーザーが個別に実行することは可能）
- 予定のフィルタリング機能（特定キーワード、参加者による絞り込みなど）
- キャッシュ機能（同じ日の予定の重複取得防止）
- 複数カレンダーからの同時取得（FR-008として将来の拡張候補）
- モバイルプラットフォーム対応（将来的な検討課題だが最優先度は最低）

## 5. ステークホルダー分析

### 5.1 エンドユーザー
- **役割**: プラグインを使用してカレンダー情報をObsidianに統合する
- **期待値**:
  - 簡単なセットアップ
  - 迅速な予定インポート
  - カスタマイズ可能なフォーマット
  - 安定した動作
- **懸念事項**:
  - Google Cloud Consoleの設定が複雑すぎる
  - 認証情報の取り扱いに不安がある

### 5.2 開発者（メンテナー）
- **役割**: プラグインの開発・保守・機能拡張
- **期待値**:
  - 保守しやすいコード構造
  - 明確な要件定義と設計
  - 十分なドキュメント
- **懸念事項**:
  - Google Calendar APIの仕様変更への対応
  - Obsidian APIの変更への対応

### 5.3 Obsidianコミュニティ
- **役割**: プラグインのレビュー、フィードバック提供
- **期待値**:
  - Obsidianのデザインガイドラインに準拠
  - セキュリティベストプラクティスに従う
  - オープンソースとして公開

## 6. 要件間の依存関係

```
FR-003 (Google Calendar API連携)
  ├─→ FR-001 (Daily Noteの日付に対応する予定のインポート)
  │     ├─→ FR-002 (カーソル位置への予定挿入)
  │     │     └─→ FR-004 (予定フォーマットのカスタマイズ)
  │     └─→ FR-006 (コマンドパレットからの実行)
  ├─→ FR-007 (カレンダーID設定)
  └─→ FR-009 (タイムゾーン設定)

FR-005 (サービスアカウント認証情報の設定)
  └─→ FR-003 (Google Calendar API連携)

FR-004 (予定フォーマットのカスタマイズ)
  └─→ FR-010 (終日予定の扱い)

FR-007 (カレンダーID設定)
  └─→ FR-008 (複数カレンダー対応) ※将来拡張
```

## 7. リスク分析

### 7.1 技術的リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| Google Calendar API仕様変更 | 高 | 低 | googleapisライブラリの定期的な更新、変更通知の監視 |
| Obsidian API仕様変更 | 中 | 中 | Obsidianのリリースノート監視、型定義の更新 |
| サービスアカウント設定の複雑性 | 中 | 高 | 詳細なセットアップガイドの提供、スクリーンショット付き手順書 |
| 大量の予定によるパフォーマンス低下 | 中 | 低 | ページネーション、取得件数制限の実装（任意） |

### 7.2 セキュリティリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| サービスアカウントキーの漏洩 | 高 | 中 | README.mdでの注意喚起、.gitignoreの推奨、読み取り専用権限の使用 |
| 不正なカレンダーへのアクセス | 低 | 低 | 読み取り専用APIスコープの使用 |

### 7.3 運用リスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| ユーザーのセットアップエラー | 中 | 高 | 詳細なドキュメント、エラーメッセージの改善 |
| API クォータ超過 | 低 | 低 | 使用量の監視方法を文書化、必要に応じてキャッシュ機能の追加（任意） |

## 8. 成功基準

### 8.1 機能面
- [ ] FR-001〜FR-007, FR-010（必須機能）がすべて実装され、動作する
- [ ] FR-009（推奨機能）が実装される
- [ ] すべての必須非機能要件（NFR-002, NFR-003, NFR-004, NFR-006, NFR-009, NFR-010）が満たされる

### 8.2 品質面
- [ ] TypeScriptのビルドエラーがゼロ
- [ ] 主要な機能（予定取得、フォーマット、挿入）が正常に動作する
- [ ] エラーハンドリングが適切に実装されている

### 8.3 ドキュメント面
- [ ] README.mdにセットアップ手順が記載されている
- [ ] トラブルシューティングガイドが含まれている
- [ ] コード内の主要な関数にコメントが記述されている

## 9. ユーザーフィードバックの反映

以下の事項について、ユーザーから明確な回答を得て要件に反映しました：

### 9.1 フォーマット関連 ✅ 反映済み
- **決定**: 終日予定と通常予定で別々のフォーマットテンプレートを用意する
- **対応**: FR-010を必須機能に変更し、2つの独立したテンプレート設定を実装

### 9.2 複数カレンダー対応 ✅ 反映済み
- **決定**: 優先度は低く、初回リリースでは未実装
- **対応**: FR-011として将来の拡張機能に位置づけ。単一カレンダーのみサポート

### 9.3 予定のフィルタリング ✅ 反映済み
- **決定**: 不要
- **対応**: スコープ外項目として明記

### 9.4 キャッシュ機能 ✅ 反映済み
- **決定**: 不要
- **対応**: スコープ外項目として明記

### 9.5 モバイル対応 ✅ 反映済み
- **決定**: 現在は不要だが、将来的には対応が望ましい（最優先度は最低）
- **対応**: C-002で将来の検討課題として明記。モバイル対応時の技術的課題（認証方式の変更など）を記載

## 10. 次のステップ

要件定義完了後、以下のステップに進むことを推奨します：

1. **技術設計フェーズ**: `/prj-define-design`コマンドを実行
   - アーキテクチャ設計
   - モジュール構成の決定
   - データフロー設計
   - エラーハンドリング戦略

2. **プロトタイプ開発**:
   - Google Calendar API連携の動作確認
   - サービスアカウント認証の実装検証
   - フォーマット機能のプロトタイプ

3. **タスク分解**: `/prj-define-tasks`コマンドを実行
   - 開発タスクの洗い出し
   - 優先順位付け
   - スケジュール作成

---

**文書バージョン**: 1.2  
**作成日**: 2025-11-01  
**最終更新日**: 2025-11-01  
**ステータス**: ユーザーフィードバック反映完了・承認待ち  
**変更履歴**:
- v1.0 (2025-11-01): 初版作成
- v1.1 (2025-11-01): ユーザーフィードバックを反映
  - FR-010を必須機能に変更（終日予定と通常予定の別フォーマット対応）
  - FR-011を追加（複数カレンダー対応を将来拡張として明記）
  - スコープ外項目を明確化（フィルタリング、キャッシュ機能など）
  - モバイル対応の将来的な検討可能性を追加
  - セクション9を「確認が必要な事項」から「ユーザーフィードバックの反映」に変更
- v1.2 (2025-11-01): FR-007（リボンアイコンからの実行）を削除
  - 旧FR-008以降の番号を繰り上げ（FR-008→FR-007, FR-011→FR-008）
  - 依存関係図を更新
  - 成功基準を更新

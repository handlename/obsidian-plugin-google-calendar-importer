# タスク定義書：Google Calendar Importer Plugin for Obsidian

## 概要

本文書は、REQUIREMENTS.md v1.2 および DESIGN.md v1.0 に基づいた実装タスクを定義する。各タスクはフェーズごとに整理され、実行可能な単位に分割されている。

**関連文書**:
- REQUIREMENTS.md v1.2
- DESIGN.md v1.0

**更新日**: 2025-11-01

---

## フェーズ1: 開発環境セットアップ

### TASK-001: Node.js/TypeScript環境の更新

- [x] Node.js v24とTypeScript 5.9.3への移行
  - **目的**: 最新の開発環境を構築し、型安全性とパフォーマンスを向上させる
  - **詳細**:
    - `.nvmrc`ファイルを作成し、Node.js v24を指定
    - `package.json`のTypeScriptバージョンを5.9.3に更新
    - `@types/node`をv24対応版に更新
    - `tsconfig.json`を最適化（DESIGN.md セクション10.3参照）
  - **完了条件**:
    - `nvm use`でNode.js v24が使用される
    - `tsc --version`でTypeScript 5.9.3が表示される
    - `npm run build`がエラーなく完了する

### TASK-002: ESLintからBiomeへの移行

- [x] Biomeのセットアップとlint/format環境の構築
  - **目的**: モダンで高速なリンター/フォーマッターに移行する
  - **詳細**:
    - ESLint関連パッケージとファイルを削除（`.eslintrc`, `.eslintignore`）
    - `@biomejs/biome`をdevDependenciesに追加
    - `biome.json`を作成（DESIGN.md セクション10.2参照）
    - `package.json`のscriptsを更新（lint, format追加）
    - 既存コードにBiomeを適用し、警告を修正
  - **完了条件**:
    - `npm run lint`がエラーなく完了する
    - `npm run format`でコード整形が実行される
    - ESLint関連ファイルが完全に削除されている

### TASK-003: 依存パッケージのインストール

- [x] 必要なライブラリの追加
  - **目的**: プロジェクトに必要な外部ライブラリをインストールする
  - **詳細**:
    - 以下のパッケージをインストール:
      - **dependencies**: `googleapis@^140.0.0`, `date-fns@^4.1.0`, `date-fns-tz@^3.2.0`, `mustache@^4.2.0`
      - **devDependencies**: `@types/mustache@^4.2.5`
    - `package-lock.json`を生成
    - `npm install`の実行とインストール確認
  - **完了条件**:
    - `package.json`に全依存パッケージが記載されている
    - `npm list`でインストール済みパッケージが表示される
    - ビルドが成功する

---

## フェーズ2: 基盤コードの実装

### TASK-004: 型定義の作成

- [x] プロジェクト全体で使用する型定義を実装
  - **目的**: 型安全性を確保し、開発効率を向上させる
  - **詳細**:
    - `src/types/settings.ts`を作成
      - `GoogleCalendarImporterSettings`インターフェース
      - `DEFAULT_SETTINGS`定数
    - `src/types/calendar.ts`を作成
      - `CalendarEvent`インターフェース
      - `ServiceAccountKey`インターフェース
    - `src/types/obsidian-daily-notes.d.ts`を作成（Daily Notes API拡張）
  - **完了条件**:
    - 全型定義ファイルが作成され、TypeScriptエラーがない
    - DESIGN.md セクション5で定義された全型が実装されている

### TASK-005: エラーハンドリング基盤の実装

- [x] アプリケーション全体のエラー処理クラスを実装
  - **目的**: 統一的なエラーハンドリングとユーザーフレンドリーなエラーメッセージを実現する
  - **詳細**:
    - `src/application/errors/AppError.ts`を作成
      - `AppError`クラス
      - `ErrorCode` enum（11種類のエラーコード）
    - エラーメッセージマッピングの実装
  - **完了条件**:
    - `AppError`クラスが全エラーコードをサポートする
    - DESIGN.md セクション6.1で定義された全エラー種別が実装されている

### TASK-006: ユーティリティの実装

- [x] 共通ユーティリティ関数の実装
  - **目的**: 再利用可能な共通機能を提供する
  - **詳細**:
    - `src/utils/logger.ts`を作成
      - コンソールログ出力機能
      - ログレベル（INFO, WARN, ERROR）
    - `src/utils/validators.ts`を作成
      - JSONキー検証関数
      - カレンダーID検証関数
      - テンプレート構文検証関数
    - `src/constants/defaults.ts`を作成
  - **完了条件**:
    - 全ユーティリティ関数が実装されている
    - 各関数の型定義が適切に設定されている

---

## フェーズ3: Infrastructure Layer の実装

### TASK-007: Google Calendar認証サービスの実装

- [x] サービスアカウント認証の実装
  - **目的**: Google Calendar APIへの安全な認証を確立する
  - **詳細**:
    - `src/infrastructure/google/AuthService.ts`を作成
      - サービスアカウントJSONキーのパース
      - `google.auth.GoogleAuth`の初期化
      - 認証クライアントの生成
      - スコープ: `https://www.googleapis.com/auth/calendar.readonly`
    - エラーハンドリング（認証エラー、JSON形式エラー）
  - **完了条件**:
    - 有効なサービスアカウントキーで認証が成功する
    - 不正なキーで適切なエラーが発生する
    - 読み取り専用スコープのみが設定されている

### TASK-008: Google Calendar APIクライアントの実装

- [x] Calendar API v3のラッパー実装
  - **目的**: イベント取得機能を提供する
  - **詳細**:
    - `src/infrastructure/google/GoogleCalendarClient.ts`を作成
      - `googleapis`ライブラリのラッパー
      - イベント一覧取得メソッド（指定日の0:00-23:59）
      - APIエラーのハンドリングと`AppError`への変換
      - ネットワークエラー、権限エラー、クォータエラーの分類
    - 非同期処理の実装
  - **完了条件**:
    - 指定日のイベント一覧が取得できる
    - 各種エラーが適切に分類され、`AppError`として返される
    - 終日イベントと通常イベントが正しく判別される

### TASK-009: 設定リポジトリの実装

- [x] プラグイン設定の永続化機能の実装
  - **目的**: 設定の保存・読み込み機能を提供する
  - **詳細**:
    - `src/infrastructure/repositories/SettingsRepository.ts`を作成
      - Obsidian Plugin Data APIの使用
      - 設定の読み込み（`loadData()`）
      - 設定の保存（`saveData()`）
      - デフォルト値のマージ処理
    - JSONシリアライゼーション
  - **完了条件**:
    - 設定の保存・読み込みが正常に動作する
    - デフォルト値が適切にマージされる
    - データディレクトリが正しく生成される（`.obsidian/plugins/google-calendar-importer/data.json`）

---

## フェーズ4: Application Layer の実装

### TASK-010: 日付抽出サービスの実装

- [x] Daily Noteファイル名から日付を抽出する機能の実装
  - **目的**: 現在開いているDaily Noteの日付を判定する
  - **詳細**:
    - `src/application/services/DateExtractorService.ts`を作成
      - Daily Notesプラグインの設定読み取り
      - ファイル名から日付をパース（date-fns使用）
      - 日付フォーマットの動的対応
      - タイムゾーン考慮
    - エラーハンドリング（日付解析失敗、Daily Noteでない場合）
  - **完了条件**:
    - 様々な日付フォーマットで日付が正しく抽出される
    - Daily Noteでないファイルで適切なエラーが発生する
    - タイムゾーンが考慮された日付が返される

### TASK-011: テンプレートフォーマットサービスの実装

- [x] イベントデータをMarkdownテキストにフォーマットする機能の実装
  - **目的**: ユーザー定義のテンプレートでイベントを整形する
  - **詳細**:
    - `src/application/services/TemplateFormatterService.ts`を作成
      - Mustacheを使用したテンプレート処理
      - 終日予定と通常予定の判定
      - テンプレート変数の展開（`{{title}}`, `{{startTime}}`, `{{endTime}}`, `{{description}}`, `{{location}}`, `{{attendees}}`）
      - 日時フォーマット（date-fns使用）
      - タイムゾーン変換
    - テンプレートエラーのハンドリング
  - **完了条件**:
    - 通常予定と終日予定が別々のテンプレートでフォーマットされる
    - 全テンプレート変数が正しく展開される
    - 不正なテンプレート構文で適切なエラーが発生する

### TASK-012: イベントインポートサービスの実装

- [x] イベントインポートの統括ロジックの実装
  - **目的**: 全体のインポートフローを調整・実行する
  - **詳細**:
    - `src/application/services/EventImportService.ts`を作成
      - 依存サービスの統合（DateExtractor, GoogleCalendarClient, TemplateFormatter）
      - イベントインポートフローの実装:
        1. 日付抽出
        2. イベント取得
        3. フォーマット
        4. エディタへの挿入
      - 非同期処理の調整
      - エラーハンドリングと通知
    - 進捗通知の実装
  - **完了条件**:
    - エンドツーエンドでイベントインポートが動作する
    - 各ステップのエラーが適切にハンドリングされる
    - ユーザーに進捗が通知される

---

## フェーズ5: Presentation Layer の実装

### TASK-013: 通知サービスの実装

- [x] ユーザー通知機能の実装
  - **目的**: 統一的なユーザーフィードバックを提供する
  - **詳細**:
    - `src/presentation/notices/NotificationService.ts`を作成
      - Obsidian Noticeを使用した通知表示
      - 成功メッセージ（緑）
      - 警告メッセージ（黄）
      - エラーメッセージ（赤）
      - エラーコード別のメッセージマッピング
    - メッセージフォーマットの統一
  - **完了条件**:
    - 各種メッセージが適切な色で表示される
    - エラーコードから適切なメッセージが生成される
    - ユーザーフレンドリーな文言になっている

### TASK-014: 設定タブUIの実装

- [x] プラグイン設定画面の実装
  - **目的**: ユーザーが設定を編集できるUIを提供する
  - **詳細**:
    - `src/presentation/settings/SettingsTab.ts`を作成
      - Obsidian Setting APIの使用
      - サービスアカウントキー入力（テキストエリア）
      - カレンダーID入力（テキスト）
      - 通常予定テンプレート編集（テキストエリア）
      - 終日予定テンプレート編集（テキストエリア）
      - タイムゾーン選択（ドロップダウン）
      - リセットボタン
    - リアルタイム検証とエラー表示
    - 設定保存機能
  - **完了条件**:
    - 全設定項目が表示・編集できる
    - 入力値が検証され、不正な場合はエラーが表示される
    - 設定が正しく保存される

### TASK-015: イベントインポートコマンドの実装

- [x] コマンドパレットからのエントリーポイント実装
  - **目的**: ユーザーがコマンドからインポートを実行できるようにする
  - **詳細**:
    - `src/presentation/commands/ImportEventsCommand.ts`を作成
      - Obsidian Commandの登録
      - 現在開いているファイルの取得と検証
      - `EventImportService`の呼び出し
      - 結果通知の表示
      - エディタへのフォーカス制御
    - エラーハンドリング
  - **完了条件**:
    - コマンドパレットに「Import Google Calendar events」が表示される
    - コマンド実行でイベントがインポートされる
    - エラー時に適切なメッセージが表示される

---

## フェーズ6: プラグインメインクラスの実装

### TASK-016: メインプラグインクラスの実装

- [x] プラグインのエントリーポイントと初期化処理の実装
  - **目的**: プラグイン全体を統合し、Obsidianに登録する
  - **詳細**:
    - `src/main.ts`を作成/更新
      - `Plugin`クラスの継承
      - `onload()`メソッド:
        - 設定の読み込み
        - 依存サービスのインスタンス化
        - コマンドの登録
        - 設定タブの登録
      - `onunload()`メソッド
      - 設定の保存・読み込みメソッド
    - 依存性注入の実装
    - ライフサイクル管理
  - **完了条件**:
    - プラグインがObsidianで正常にロード/アンロードされる
    - 全コマンドが登録される
    - 設定タブが表示される

### TASK-017: manifest.jsonの更新

- [x] プラグインメタデータの更新
  - **目的**: プラグイン情報を正しく設定する
  - **詳細**:
    - `manifest.json`を更新
      - `id`: `google-calendar-importer`
      - `name`: `Google Calendar Importer`
      - `version`: `0.1.0`
      - `minAppVersion`: `0.15.0`
      - `description`: 適切な説明文
      - `author`: 作成者情報
      - `isDesktopOnly`: `true`（デスクトップ専用）
    - バージョン管理設定
  - **完了条件**:
    - manifest.jsonが適切に設定されている
    - Obsidianでプラグイン情報が正しく表示される

---

## フェーズ7: 統合テストとバグ修正

### TASK-018: エンドツーエンドテスト

- [ ] 実際の環境でのテスト実施
  - **目的**: 全機能が正常に動作することを確認する
  - **詳細**:
    - テストシナリオの作成:
      1. プラグインのインストールと有効化
      2. 設定画面での認証情報設定
      3. Daily Noteを開く
      4. コマンド実行
      5. イベントがインポートされることを確認
    - 異なる日付フォーマットでのテスト
    - 終日予定と通常予定の混在ケース
    - タイムゾーン変換の確認
    - エラーケースのテスト
  - **完了条件**:
    - 全シナリオが成功する
    - 発見されたバグがすべて修正されている
    - エラーメッセージが適切に表示される

### TASK-019: エラーハンドリングのテスト

- [ ] 各種エラーケースの動作確認
  - **目的**: エラー処理が正しく機能することを確認する
  - **詳細**:
    - 以下のエラーケースをテスト:
      - ネットワーク切断時
      - 不正な認証情報
      - カレンダーアクセス権限なし
      - APIクォータ超過
      - Daily Noteでないファイル
      - 不正なテンプレート構文
    - 各エラーでの通知内容確認
    - ログ出力の確認
  - **完了条件**:
    - 全エラーケースで適切なメッセージが表示される
    - プラグインがクラッシュしない
    - 詳細ログがコンソールに出力される

### TASK-020: パフォーマンステスト

- [ ] レスポンス時間とUI応答性の確認
  - **目的**: NFR-001、NFR-002の要件を満たすことを確認する
  - **詳細**:
    - API応答時間の測定（10秒以内）
    - UI フリーズの有無確認
    - 大量イベント（100件以上）での動作確認
    - メモリ使用量の確認
  - **完了条件**:
    - API応答時間が10秒以内
    - インポート中もObsidianが操作可能
    - メモリリークがない

---

## フェーズ8: ドキュメント整備

### TASK-021: README.mdの作成

- [x] ユーザー向けドキュメントの作成
  - **目的**: NFR-010の要件を満たし、ユーザーがセットアップできるようにする
  - **詳細**:
    - 以下のセクションを含むREADME.mdを作成:
      - プラグイン概要
      - 機能一覧
      - インストール方法
      - セットアップ手順（Google Cloud Console設定含む）
      - 使用方法
      - カスタマイズ（テンプレート編集）
      - トラブルシューティング
      - FAQ
      - ライセンス
    - スクリーンショットの追加
  - **完了条件**:
    - README.mdが完成している
    - セットアップ手順が明確に記載されている
    - トラブルシューティングガイドが充実している

### TASK-022: Google Cloud Consoleセットアップガイドの作成

- [x] サービスアカウント作成手順の詳細ドキュメント作成
  - **目的**: 技術知識が限られたユーザーでもセットアップできるようにする
  - **詳細**:
    - 別ファイル（SETUP_GUIDE.md）または README.mdのセクションとして作成
    - 以下の手順を詳細に記載:
      1. Google Cloud Projectの作成
      2. Calendar APIの有効化
      3. サービスアカウントの作成
      4. JSONキーのダウンロード
      5. カレンダーの共有設定
    - 各ステップのスクリーンショット付き
    - よくあるエラーと対処法
  - **完了条件**:
    - セットアップガイドが完成している
    - 手順が明確でわかりやすい
    - スクリーンショットが含まれている

### TASK-023: CHANGELOG.mdの作成

- [x] 変更履歴ドキュメントの作成
  - **目的**: バージョン管理と変更追跡を可能にする
  - **詳細**:
    - CHANGELOG.mdを作成
    - v0.1.0の変更内容を記載
    - 将来のバージョン管理のためのフォーマット定義
  - **完了条件**:
    - CHANGELOG.mdが作成されている
    - 初回リリースの内容が記載されている

---

## フェーズ9: リリース準備

### TASK-024: ビルド設定の最終確認

- [x] 本番ビルドの動作確認
  - **目的**: 配布可能なビルド成果物を生成する
  - **詳細**:
    - `npm run build`の実行と確認
    - `main.js`のバンドルサイズ確認
    - minificationの確認
    - source mapの除外確認
    - 未使用コードのTree-shaking確認
  - **完了条件**:
    - ビルドが成功する
    - `main.js`が生成される
    - バンドルサイズが適切（目安: 500KB以下）

### TASK-025: .gitignoreの整備

- [x] 不要なファイルの除外設定
  - **目的**: リポジトリに不要なファイルを含めない
  - **詳細**:
    - `.gitignore`の更新:
      - `node_modules/`
      - `main.js`
      - `*.map`
      - `.obsidian/`（テスト用vault）
      - `data.json`（設定ファイル）
      - `.DS_Store`
      - `npm-debug.log`
    - 既存の追跡ファイルの削除（必要に応じて）
  - **完了条件**:
    - `.gitignore`が適切に設定されている
    - 不要なファイルがリポジトリに含まれていない

### TASK-026: ライセンスファイルの確認

- [ ] LICENSEファイルの内容確認と更新
  - **目的**: ライセンス情報を明確にする
  - **詳細**:
    - LICENSEファイルの確認
    - 必要に応じて作成者情報の更新
    - manifest.jsonとの整合性確認
  - **完了条件**:
    - LICENSEファイルが適切に設定されている

---

## フェーズ10: オプショナル（推奨機能）

### TASK-027: タイムゾーン設定機能の実装（FR-009）

- [ ] タイムゾーン選択機能の実装
  - **目的**: 異なるタイムゾーンでの時刻表示に対応する
  - **詳細**:
    - 設定タブにタイムゾーン選択ドロップダウンを追加
    - IANA タイムゾーン一覧の取得
    - `date-fns-tz`を使用したタイムゾーン変換
    - デフォルト: システムのタイムゾーン
  - **完了条件**:
    - タイムゾーンが選択できる
    - 選択したタイムゾーンで時刻が表示される
    - システムのタイムゾーンがデフォルトとして設定される

---

## 依存関係マップ

```
フェーズ1 (セットアップ)
  ├─→ フェーズ2 (基盤コード)
  │     ├─→ フェーズ3 (Infrastructure)
  │     └─→ フェーズ4 (Application)
  │           └─→ フェーズ5 (Presentation)
  │                 └─→ フェーズ6 (プラグインメイン)
  │                       └─→ フェーズ7 (テスト)
  │                             └─→ フェーズ8 (ドキュメント)
  │                                   └─→ フェーズ9 (リリース)
  └─→ フェーズ10 (オプショナル) ※並行実行可能
```

## タスク実行ガイド

### 推奨実行順序

1. **フェーズ1**: 最初に完了させる（他のすべてのフェーズの前提条件）
2. **フェーズ2**: 次に完了させる（全レイヤーの基盤）
3. **フェーズ3, 4, 5**: 下位レイヤーから順に実装（Infrastructure → Application → Presentation）
4. **フェーズ6**: 全レイヤー完成後に実装
5. **フェーズ7**: 実装完了後にテスト
6. **フェーズ8, 9**: テスト完了後にドキュメント整備とリリース準備
7. **フェーズ10**: 任意のタイミングで実装可能

### 並行実行可能なタスク

- **TASK-001, 002, 003**: フェーズ1内で並行実行可能
- **TASK-004, 005, 006**: フェーズ2内で並行実行可能
- **TASK-007, 008, 009**: フェーズ3内で並行実行可能（ただしTASK-008はTASK-007に依存）
- **TASK-021, 022, 023**: フェーズ8内で並行実行可能
- **フェーズ10**: 他のフェーズと並行実行可能

### タスク実行時の注意点

- 各タスク完了後は必ず`npm run build`でビルド確認を行う
- `npm run lint`でコード品質を確認する
- git commitは意味のある単位で行う（推奨: 各タスク完了ごと）
- エラーが発生した場合は、依存タスクの完了状況を確認する

---

## 進捗管理

### タスクステータス

- `[ ]`: 未着手
- `[*]`: 作業中
- `[x]`: 完了
- `[!]`: ブロック中（他タスク待ち）
- `[?]`: 要確認

### 完了報告

各フェーズ完了時に、以下を確認してください：

1. すべてのタスクが完了している
2. ビルドが成功している
3. Lintエラーがない
4. 関連するドキュメントが更新されている
5. 変更がコミットされている

---

**次のステップ**: タスク実行を開始する場合は、`/prj-exec-task TASK-001`のようにスラッシュコマンドを実行してください。

**文書バージョン**: 1.0  
**作成日**: 2025-11-01  
**ステータス**: 初版  
**関連文書**: REQUIREMENTS.md v1.2, DESIGN.md v1.0
